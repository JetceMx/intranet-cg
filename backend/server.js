const express = require('express');
const cors = require('cors');
const bodyParser = require('body-parser');
const { Connection, Request, TYPES } = require('tedious');
const jwt = require('jsonwebtoken');
require('dotenv').config();

const app = express();
const PORT = process.env.PORT; 
const SECRET_KEY = process.env.JWT_SECRET;

// Middleware
app.use(cors());
app.use(bodyParser.json());

// Configuraci√≥n de conexi√≥n a SQL Server
const dbConfig = {
  server: process.env.DB_SERVER,
  authentication: {
    type: 'default',
    options: {
      userName: process.env.DB_USER,
      password: process.env.DB_PASSWORD
    }
  },
  options: {
    database: process.env.DB_DATABASE,
    trustServerCertificate: true,
    encrypt: false,
    port: parseInt(process.env.DB_PORT, 10)
  }
};

// Funci√≥n para probar la conexi√≥n
const testConnection = () => {
  const connection = new Connection(dbConfig);
  
  connection.on('connect', (err) => {
    if (err) {
      console.error('‚ùå Error de conexi√≥n:', err.message);
    } else {
      console.log('‚úÖ Conexi√≥n exitosa a SQL Server');
      connection.close();
    }
  });
  
  connection.connect();
};

// Probar conexi√≥n al iniciar
testConnection();

// Middleware para verificar JWT
const verifyToken = (req, res, next) => {
  const token = req.headers['authorization']?.split(' ')[1]; // Bearer TOKEN
  
  if (!token) {
    return res.status(403).json({ message: 'Token requerido' });
  }
  
  jwt.verify(token, SECRET_KEY, (err, decoded) => {
    if (err) {
      return res.status(401).json({ message: 'Token inv√°lido' });
    }
    req.userId = decoded.id;
    next();
  });
};

// Ruta POST: /api/auth/login
app.post('/api/auth/login', (req, res) => {
  const { email, password } = req.body;
  
  console.log('üìß Email recibido:', email);
  console.log('üîê Password recibido:', password);

  const connection = new Connection(dbConfig);
  
  connection.on('connect', (err) => {
    if (err) {
      console.error('‚ùå Error al conectar con la BD:', err.message);
      return res.status(500).json({ message: "Error al conectar con la base de datos" });
    }
    
    console.log('‚úÖ Conectado a la BD para login');

    // Consulta con JOIN para obtener informaci√≥n del rol y √°rea
    const checkUserSql = `
      SELECT 
        u.*,
        r.NombreRol as Rol,
        a.NombreArea as Area
      FROM Usuarios u
      LEFT JOIN Roles r ON u.IdRol = r.IdRol
      LEFT JOIN Areas a ON u.IdArea = a.IdArea
      WHERE u.Correo = @correo
    `;
    
    let foundUser = null;
    
    const checkRequest = new Request(checkUserSql, (err, rowCount) => {
      connection.close();
      
      if (err) {
        console.error('‚ùå Error en consulta de verificaci√≥n:', err.message);
        return res.status(500).json({ message: "Error en la consulta" });
      }

      console.log('üìä Filas encontradas:', rowCount);
      
      if (rowCount === 0 || !foundUser) {
        console.log('‚ùå Usuario no encontrado con email:', email);
        return res.status(401).json({ message: "Usuario no encontrado" });
      }
      
      console.log('üë§ Usuario encontrado:', foundUser.Correo);
      console.log('üîê Contrase√±a en BD:', foundUser.Contrasena || foundUser.Password || foundUser.password);
      console.log('üîê Contrase√±a enviada:', password);
      
      // Verificar contrase√±a (probamos diferentes nombres de columna)
      const dbPassword = foundUser.Contrasena || foundUser.Password || foundUser.password || foundUser.contrase√±a;
      
      if (!dbPassword) {
        console.log('‚ùå No se encontr√≥ columna de contrase√±a en la BD');
        return res.status(500).json({ message: "Error: columna de contrase√±a no encontrada" });
      }
      
      if (dbPassword !== password) {
        console.log('‚ùå Contrase√±a incorrecta');
        return res.status(401).json({ message: "Contrase√±a incorrecta" });
      }
      
      console.log('‚úÖ Login exitoso');
      
      // Generar token JWT con informaci√≥n adicional
      const userId = foundUser.IdUsuario || foundUser.Id || foundUser.id;
      const userRole = foundUser.Rol || 'empleado'; // rol por defecto
      const userArea = foundUser.Area || 'general'; // √°rea por defecto
      
      const token = jwt.sign({ 
        id: userId, 
        rol: userRole, 
        area: userArea 
      }, SECRET_KEY, { expiresIn: '2h' });
      
      // Crear copia del usuario sin contrase√±a para la respuesta
      const userResponse = {
        id: userId,
        nombre: foundUser.Nombre || foundUser.NombreCompleto,
        email: foundUser.Correo,
        rol: userRole.toLowerCase(),
        area: userArea.toLowerCase(),
        activo: foundUser.Activo || foundUser.Estado
      };
      
      // Limpiar todas las posibles columnas de contrase√±a
      delete userResponse.Contrasena;
      delete userResponse.Password;
      delete userResponse.password;
      delete userResponse.contrase√±a;
      
      console.log('üì§ Respuesta enviada:', { user: userResponse, hasToken: !!token });
      
      return res.json({ 
        token, 
        user: userResponse,
        message: "Login exitoso"
      });
    });

    // Evento 'row' para capturar los datos del usuario
    checkRequest.on('row', (columns) => {
      console.log('üîç Datos del usuario recibidos:', columns.length, 'columnas');
      foundUser = {};
      
      columns.forEach(column => {
        console.log('üîç Columna:', column.metadata.colName, '- Valor:', column.value);
        foundUser[column.metadata.colName] = column.value;
      });
      
      console.log('üë§ Usuario procesado:', foundUser);
    });

    checkRequest.addParameter('correo', TYPES.VarChar, email);
    connection.execSql(checkRequest);
  });
  
  connection.connect();
});

// Ruta para obtener informaci√≥n del usuario actual (protegida)
app.get('/api/auth/me', verifyToken, (req, res) => {
  const connection = new Connection(dbConfig);
  
  connection.on('connect', (err) => {
    if (err) {
      return res.status(500).json({ message: "Error de conexi√≥n" });
    }
    
    const sql = `
      SELECT 
        u.IdUsuario,
        u.Nombre,
        u.Correo,
        u.Activo,
        r.NombreRol as Rol,
        a.NombreArea as Area
      FROM Usuarios u
      LEFT JOIN Roles r ON u.IdRol = r.IdRol
      LEFT JOIN Areas a ON u.IdArea = a.IdArea
      WHERE u.IdUsuario = @userId
    `;
    
    let user = null;
    
    const request = new Request(sql, (err, rowCount) => {
      connection.close();
      
      if (err) {
        return res.status(500).json({ message: "Error en consulta" });
      }
      
      if (!user) {
        return res.status(404).json({ message: "Usuario no encontrado" });
      }
      
      res.json({
        id: user.IdUsuario,
        nombre: user.Nombre,
        email: user.Correo,
        rol: (user.Rol || 'empleado').toLowerCase(),
        area: (user.Area || 'general').toLowerCase(),
        activo: user.Activo
      });
    });
    
    request.on('row', (columns) => {
      user = {};
      columns.forEach(column => {
        user[column.metadata.colName] = column.value;
      });
    });
    
    request.addParameter('userId', TYPES.Int, req.userId);
    connection.execSql(request);
  });
  
  connection.connect();
});


// Ruta para obtener todos los recursos con filtros (protegida)
app.get('/api/recursos', verifyToken, (req, res) => {
  const connection = new Connection(dbConfig);
  
  connection.on('connect', (err) => {
    if (err) {
      return res.status(500).json({ message: "Error de conexi√≥n" });
    }
    
    // Si tienes una tabla de recursos, √∫sala; si no, devuelve datos est√°ticos
    const sql = `
      SELECT 
        r.*,
        rp.Rol,
        rp.Area
      FROM Recursos r
      LEFT JOIN RecursosPermisos rp ON r.IdRecurso = rp.IdRecurso
      WHERE rp.Rol IS NULL 
         OR rp.Rol = 'todos' 
         OR rp.Area = 'todas'
      ORDER BY r.Categoria, r.Nombre
    `;
    
    // Como probablemente no tienes esta tabla a√∫n, devolvemos datos est√°ticos
    const recursosEstaticos = [
      {
        categoria: "Manuales",
        items: [
          {
            nombre: "Manual del Usuario",
            url: "/docs/manual-usuario.pdf",
            roles: ["admin", "supervisor", "empleado"],
            areas: ["todas"]
          },
          {
            nombre: "Manual T√©cnico",
            url: "/docs/manual-tecnico.pdf",
            roles: ["admin", "supervisor"],
            areas: ["ti", "ingenieria"]
          }
        ]
      }
    ];
    
    connection.close();
    res.json(recursosEstaticos);
  });
  
  connection.connect();
});


// Ruta para verificar la estructura de la tabla (solo para debug)
app.get('/api/debug/usuarios', (req, res) => {
  const connection = new Connection(dbConfig);
  
  connection.on('connect', (err) => {
    if (err) {
      console.error('‚ùå Error al conectar:', err.message);
      return res.status(500).json({ error: err.message });
    }

    const sql = `
      SELECT TOP 5 
        u.*,
        r.NombreRol,
        a.NombreArea
      FROM Usuarios u
      LEFT JOIN Roles r ON u.IdRol = r.IdRol
      LEFT JOIN Areas a ON u.IdArea = a.IdArea
    `;
    
    const users = [];
    
    const request = new Request(sql, (err, rowCount) => {
      connection.close();
      
      if (err) {
        console.error('‚ùå Error en consulta debug:', err.message);
        return res.status(500).json({ error: err.message });
      }

      console.log('‚úÖ Consulta completada. Usuarios encontrados:', users.length);
      res.json({ rowCount, users, totalFound: users.length });
    });

    request.on('row', (columns) => {
      const user = {};
      columns.forEach(column => {
        // No mostrar contrase√±as en debug
        if (!['Contrasena', 'Password', 'password', 'contrase√±a'].includes(column.metadata.colName)) {
          user[column.metadata.colName] = column.value;
        }
      });
      users.push(user);
    });

    connection.execSql(request);
  });
  
  connection.connect();
});


// Ruta para obtener usuarios que cumplen a√±os el dia actual
app.get("/api/cumple-hoy", (req, res) => {
  const connection = new Connection(dbConfig);

  connection.on("connect", (err) => {
    if (err) {
      console.error("‚ùå Error al conectar:", err.message);
      return res.status(500).json({ error: "Error de conexi√≥n" });
    }

    const hoy = new Date();
    const dia = hoy.getDate();
    const mes = hoy.getMonth() + 1;

    console.log(`üìÖ Buscando cumplea√±os para el d√≠a ${dia} / ${mes}`);

    const sql = `
      SELECT Nombre, FechaNacimiento
      FROM Usuarios
      WHERE DAY(FechaNacimiento) = @dia
        AND MONTH(FechaNacimiento) = @mes
    `;

    const cumpleanieros = [];

    const request = new Request(sql, (err) => {
      connection.close();

      if (err) {
        console.error("‚ùå Error en consulta:", err.message);
        return res.status(500).json({ error: "Error en consulta" });
      }

      console.log(`‚úÖ Total cumplea√±os encontrados: ${cumpleanieros.length}`);
      res.json({
        tieneCumple: cumpleanieros.length > 0,
        nombres: cumpleanieros.map(c => c.Nombre),
        detalles: cumpleanieros // üëà Esto es solo para debug
      });
    });

    request.on("row", (columns) => {
      const persona = {};
      columns.forEach(col => {
        persona[col.metadata.colName] = col.value;
      });
      console.log("üéØ Cumplea√±ero encontrado:", persona);
      cumpleanieros.push(persona);
    });

    request.addParameter("dia", TYPES.Int, dia);
    request.addParameter("mes", TYPES.Int, mes);
    connection.execSql(request);
  });

  connection.connect();
});



// Ruta para logout (opcional)
app.post('/api/auth/logout', verifyToken, (req, res) => {
  // En una implementaci√≥n m√°s robusta, podr√≠as invalidar el token en una blacklist
  res.json({ message: 'Logout exitoso' });
});

// Iniciar servidor
app.listen(PORT, () => {
  console.log(`üöÄ Backend corriendo en http://localhost:${PORT}`);
  /*
  console.log(`üìã Rutas disponibles:`);
  console.log(`   POST /api/auth/login`);
  console.log(`   GET  /api/auth/me`);
  console.log(`   GET  /api/recursos`);
  console.log(`   POST /api/auth/logout`);
  console.log(`   GET  /api/debug/usuarios`);
  */

});